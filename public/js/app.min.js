!function(){"use strict";function s(t){var e=$('<li class="entry"></li>');e.append(t),C.append(e),C[0].scrollTop=C[0].scrollHeight}function i(t,e){F.removeClass().text(t),e&&(F.addClass(e),A.addClass(e),setTimeout(function(){A.removeClass(e)},350))}function p(t){var e,n;W.focus(),g&&ot(),m!==t&&(g=t,I.css("margin-right","4px"),I.text("To "+t+":"),e=I.outerWidth(!0)+1,I.hide(),W.animate({width:"-="+e+"px"},"fast",function(){I.show()}),(n=$(".name").filter(function(){return $(this).text()===t})).prevAll(".private").show(),n.off("click").on("click",ot))}function n(t){u&&(u.removeClass("btn-success").addClass("btn-danger disabled"),u.html('<i class="icon-play icon-white"></i> Wait')),h=!1,clearInterval(y),nt(Date.now()+5e3,!1);var e=t.artistName.replace(/"/g,"&quot;"),n=t.trackName.replace(/"/g,"&quot;"),a="",o="";0<K&&(o="+"+K,3<K&&(a+='class="icons round-rank stand'+(7-K)+'"'));var i=['<li class="bordered">','<img class="artwork" src="'+t.artworkUrl+'"/>','<div class="info">','<div class="artist" title="'+e+'">'+e+"</div>",'<div class="title" title="'+n+'">'+n+"</div>","</div>","<div "+a+"></div>",'<div class="round-points">'+o+"</div>",'<a class="icons" target="itunes_store" href="'+t.trackViewUrl+'"></a>',"</li>"].join("");O.prepend(i)}function r(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function a(t){var a=['<div class="modal-dialog modal-xl modal-danger modal-dialog-centered modal-" role="document">','<div class="modal-content bg-gradient-danger">','<div class="modal-header">','<h6 class="modal-title" id="modal-title-notification">Game over!</h6>','<button type="button" class="close" data-dismiss="modal" aria-label="Close">','<span aria-hidden="true">×</span>',"</button>","</div>",'<div class="modal-body">','<div class="py-3 text-center">','<i class="ni ni-trophy ni-3x"></i>','<table class="table table-striped scoreboard">',"<thead>","<tr>","<th>#</th>","<th>Name</th>","<th>Points</th>",'<th><div class="icons cups stand1"></div></th>','<th><div class="icons cups stand2"></div></th>','<th><div class="icons cups stand3"></div></th>',"<th>Guessed</th>","<th>Mean time</th>","</tr>","</thead>","<tbody>","</div>","</div>","</div>","</div>","</div>","</div>"];t.forEach(function(t,e){a.push("<tr>"),a.push('<td><div class="icons medals rank'+(e+1)+'"></div></td>'),a.push('<td class="name">'+t.nickname+"</td>"),a.push("<td>"+t.points+"</td>"),a.push("<td>"+t.golds+"</td>"),a.push("<td>"+t.silvers+"</td>"),a.push("<td>"+t.bronzes+"</td>"),a.push("<td>"+t.guessed+"</td>");var n="N/A";0!==t.guessed&&(n=((n=t.totguesstime/t.guessed)/1e3).toFixed(1)+" s"),a.push("<td>"+n+"</td>"),a.push("</tr>")}),a.push("</tbody>","</table>","</div>"),a.push('<div class="modal-footer align-left">'),a.push('<button type="button" class="btn btn-white">Ok, Got it</button>'),a.push("A new game will start in <span> </span>_seconds"),a.push("</div>"),Y.append(a.join("")).modal("show"),it(Date.now()+1e4)}function o(t,e,n){var a,o,i;R[e]||(a=$('<span class="message"></span>'),o=e,n&&(m===e?o="(To "+n+")":(o="(From "+e+")",b=e),a.addClass("private")),i=o+": "+t.replace(/<3/g,"♥"),a.html(dt(i)),s(a))}function t(){T.toggle(300),G.text("Show chat"),G.off("click").on("click",rt),O.animate({maxHeight:"434px"},300)}function l(t){v.src=t}function c(t){u&&(u.html('<i class="icon-play icon-white"></i> Play'),u.removeClass("btn-danger disabled").addClass("btn-success")),v.play(),A.val(""),h=!0,clearInterval(y),nt(Date.now()+3e4,!0),ct(t.users),1===t.counter&&(Y.modal("hide").empty(),O.empty()),H.text(t.counter+"/"+t.tot),i("What is this song?")}function e(a){return function(t,e){if(e.append("you are not allowed to "+a+" a player."),!L)return s(e);var n=[a,t[0]];"kick"===a?n.push(t[1]||""):t[1]?t[2]?n.push(t[1],t[2]):/^[1-9][0-9]*$/.test(t[1])?n.push("",t[1]):n.push(t[1],""):n.push("",""),n.push(function(t){t||s(e)}),f.send.apply(f,n)}}function d(n,a){var o=n.length;return function(){var t=Math.floor(Math.random()*o),e=n[t];i(e,a)}}var u,v,h,m,f,g,b,y,k,w,x=$("#cassette .wheel"),C=$("#chat"),T=$("#chat-outer-wrapper"),j=$("#countdown"),F=$("#feedback"),A=$("#guess"),W=$("#message"),Y=$("#modal"),D=$("#summary .points"),E=$("#progress"),N=$("#summary .rank"),I=$("#recipient"),P=$("#tape-left"),M=$("#tape-right"),G=$("#toggle-chat"),H=$("#summary .track"),O=$("#tracks"),S=$("#users"),_=0,U=0,z=[],R={},q=location.pathname.replace(/\//g,""),K=0,L=!1,V=/(https?:\/\/[-A-Za-z0-9+&@#/%?=~_()|!:,.;]*[-A-Za-z0-9+&@#/%=~_()|])/,Z=[],B={},J=["Do you also know the title?","Exactly, now tell me the title!","Yes, that's the artist. What about the title?"],Q=["Congratulations","Exactly","Excellent","Good job!","Great!","I'm proud of you","Keep it up!","Perfect","Super duper","That's it!","Very well done","Woohoo!","Yeah true, do you like this track?","Yes, you're right","You make it look easy","You remembered","You rock!"],X=["Are you kidding?","Don't give up","Fail","Haha, what?!","Incorrect answer","It is not that hard","Keep trying","No way!","No","Nope","Nope, sorry!","Oh, come on!","That's wrong","Try again","What?!","Wrong"],tt=["A song is already playing, please wait...","Game is about to start...","Game is over","New game will start soon..."],et=["Correct, do you also know the artist?","Now tell me the artist!","Yes, you guessed the title. Who is the artist?"],nt=function(t,e){var n,a,o,i,s,r,l,c;(l=function(){if(o=t-Date.now(),r=o/1e3,o<50)return clearInterval(y);s=e?(u&&(_=30-Math.round(r)),j.text(r.toFixed(1)),c=148-148*(a=r/30),n=360*a-360,i=20+24*a,106+24*a):(j.text(Math.round(r)),c=148*(a=r/5),n=-360*a,i=44-24*a,130-24*a),x.css("transform","rotate("+n+"deg)"),E.width(c),P.css("left",i+"px"),M.css("left",s+"px")})(),y=setInterval(l,50)},at=function(t){if(t=t?'<span class="label label-important">'+t+"</span><br/>Try with another one:":"What's your name?",Y.hasClass("in"))return $(".modal-body p").html(t),$("#login").focus();var e=['<div class="modal-dialog modal-dialog-centered modal-sm" role="document">','<div class="modal-content">','<div class="modal-body p-0">','<div class="card bg-secondary shadow border-0 mb-0">','<div class="card-header bg-white pb-5">','<div class="text-center text-muted mb-4">',"<small>You are joining the "+q+" room</small>","</div>",'<form role="form">','<div class="form-group mb-3">','<div class="input-group input-group-alternative">','<div class="input-group-prepend">','<span class="input-group-text"><i class="ni ni-email-83"></i></span>',"</div>",'<input class="form-control" placeholder="@nickname" input id="login" maxlength="15" type="text" name="nickname">',"</div>","</div>",'<div class="text-center">','<button id="join" type="button" class="btn btn-primary my-4">Enter</button>',"</div>","</form>","</div>","</div>","</div>","</div>","</div>"].join("");$(e).appendTo(Y);var n=$("#join"),a=$("#login");n.on("click",function(){var t=a.val();if(a.val(""),t.trim())return f.send("nickname",t);at("Nickname can't be empty.")}),a.on("keyup",function(t){13===t.keyCode&&n.click()}),Y.modal("show").on("shown",function(){a.focus()})},ot=function(){var t=I.outerWidth(!0)+1;I.css("margin-right","0"),I.text(""),W.animate({width:"+="+t+"px"},"fast");var e=$(".name").filter(function(){return $(this).text()===g});e.prevAll(".private").hide(),e.off("click").on("click",function(){p($(this).text())}),g="",W.focus()},it=function(t){var e=t-Date.now(),n=e/1e3;$(".modal-footer span").text(Math.round(n)),e<200||setTimeout(function(){it(t)},200)},st=function(t){0===t.status?(h=!0,nt(Date.now()+t.timeleft,!0)):1===t.status&&l(t.previewUrl),i(tt[t.status])},rt=function(){T.toggle(300),G.text("Hide chat"),G.off("click").on("click",t),O.animate({maxHeight:"240px"},300,function(){C[0].scrollTop=C[0].scrollHeight})},lt=function(t){var e,n=$('<span class="message private">(From binb): </span>');try{e=function(t){for(var e,n=!1,a="",o=[],i=0;i<t.length;i++)if("\\"!==t[i]){'"'!==t[i]?" "!==t[i]?a+=t[i]:n?a+=" ":a.length&&(o.push(a),a=""):(e=i+1,(n=!n)||" "!==t[e]&&e!==t.length||(o.push(a),a="",i=e))}else{if(++i===t.length)throw new Error("SyntaxError: Unexpected end of input");if("\\"===t[i]||'"'===t[i]||!n){a+=t[i];continue}a+="\\"+t[i]}if(n)throw new Error("SyntaxError: Unexpected end of input");return a.length&&o.push(a),o}(t)}catch(t){return n.append(t.message),s(n)}var a=e.shift(),o=ht[a.substr(1)];if(o)return e.length<o.minargs?(n.append(o.usage),s(n)):!o.checkrecipient||e[0]&&e[0]!==m?o.fn(e,n):(n.append("invalid argument."),s(n));n.text("(From binb): unknown command "+a+"."),s(n)},ct=function(d){S.empty(),Z=Object.keys(d).sort(function(t,e){return d[e].points-d[t].points});var t,u=!1;Z.forEach(function(t,e){t=d[t];var n,a=$('<span class="guess-time"></span>'),o=$("<li></li>"),i=$('<span class="points">('+t.points+")</span>"),s=$('<span class="private label label-info">P</span>'),r=$('<span class="round-points"></span>'),l=$("<span></span>"),c=$('<span class="name">'+t.nickname+"</span>");if(o.append(s,c,i,l,r,a),t.registered&&(n='href="/user/'+t.nickname+'"',s.after('<a class="icons registered" target="_blank" '+n+"></a>")),S.append(o),g===t.nickname?(s.show(),c.on("click",ot),u=!0):c.on("click",function(){p($(this).text())}),m===t.nickname&&(D.text(t.points),N.text(e+1),c.addClass("you"),K=t.roundpoints),0<t.roundpoints){if(r.text("+"+t.roundpoints),"artist"===t.matched||"title"===t.matched)return c.addClass("matched"+t.matched);c.addClass("correct"),2<t.roundpoints&&a.text((t.guesstime/1e3).toFixed(1)+" s"),3<t.roundpoints&&l.addClass("icons round-rank stand"+(7-t.roundpoints))}}),!u&&g&&(g="",t=I.outerWidth(!0)+1,I.css("margin-right","0"),I.text(""),W.animate({width:"+="+t+"px"},"fast"))},dt=function(t){if(V.test(t)){for(var e="",n=t.split(V),a=0;a<n.length;a++){var o=r(n[a]);V.test(n[a])?e+='<a target="_blank" href="'+o+'">'+o+"</a>":e+=o}return e}return r(t)},ut=function(t,e){var n=$('<span class="join">'+t+" joined the game</span>");s(n),ct(e)},pt=function(t,e){var n=$('<span class="left">'+t+" left the game</span>");s(n),ct(e)},ht={ban:{checkrecipient:!0,fn:e("ban"),minargs:1,usage:"usage: /ban &lt;player&gt; [&lt;message&gt;] [&lt;duration&gt;]"},clear:{fn:function(){C.empty()},minargs:0},ignore:{checkrecipient:!0,fn:function(t,n){if(R[t[0]])return n.text("(From binb): "+t[0]+" is already ignored."),s(n);f.send("ignore",t[0],function(t,e){return t?(R[e]=!0,n.text("(From binb): "+e+" is now ignored."),s(n)):(n.append("player not found."),void s(n))})},minargs:1,usage:"usage: /ignore &lt;player&gt;"},kick:{checkrecipient:!0,fn:e("kick"),minargs:1,usage:"usage: /kick &lt;player&gt; [&lt;message&gt;]"},unban:{fn:function(t,e){if(e.append("you are not allowed to unban a player."),!L)return s(e);f.send("unban",t[0],function(t){t||s(e)})},minargs:1,usage:"usage: /unban &lt;IP&gt;|list"},unignore:{checkrecipient:!0,fn:function(t,e){if(!R[t[0]])return e.text("(From binb): you have not ignored "+t[0]+"."),s(e);delete R[t[0]],f.send("unignore",t[0]),e.text("(From binb): "+t[0]+" is no longer ignored."),s(e)},minargs:1,usage:"usage: /unignore &lt;player&gt;"},private:{checkrecipient:!0,fn:function(t,e){if(!~Z.indexOf(t[0]))return e.text("(From binb): There's no one here by that name."),s(e);p(t[0])},minargs:1,usage:"usage: /private &lt;player&gt;"},reply:{fn:function(t,e){return b?~Z.indexOf(b)?void p(b):(e.text("(From binb): "+b+" isn't here anymore."),s(e)):(e.text("(From binb): There's no one to reply to."),s(e))},minargs:0},unprivate:{fn:ot,minargs:0}};Y.modal({backdrop:"static",keyboard:!1,show:!1}),G.click(t),(v=new Audio).preload="auto",v.volume=1,/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)?(k=['<div id="touch-backdrop">','<button id="touch-play" class="btn btn-danger disabled">','<i class="icon-play icon-white"></i> Wait',"</button>","</div>"].join(""),(w=$(k)).appendTo("#cassette"),(u=$("#touch-play")).on("click",function(){$(this).hasClass("btn-danger")||(v.currentTime=_,v.play(),w.remove(),u=null)})):function(){var t=['<div id="volume-button">','<a class="button">','<div id="icon" class="icons volume-high"></div>',"</a>",'<div id="volume-slider">','<div id="volume-total"></div>','<div id="volume-current"></div>','<div id="volume-handle"></div>',"</div>","</div>"].join(""),e=$(t),n=e.find("#icon"),s=e.find("#volume-current"),r=e.find("#volume-handle"),o=e.find("#volume-slider"),l=e.find("#volume-total"),c=!1,a=!1,i=!1,d=1;e.appendTo("#volume");function u(t){0===t?n.removeClass().addClass("icons volume-none"):t<=.33?n.removeClass().addClass("icons volume-low"):t<=.66?n.removeClass().addClass("icons volume-medium"):n.removeClass().addClass("icons volume-high")}function p(t){var e=l.height(),n=l.offset(),a=parseInt(l.css("top").replace(/px/,""),10),o=t.pageY-n.top,i=(e-o)/e;c=!1,o<0?o=0:e<o&&(o=e),s.height(e-o),s.css("top",o+a),r.css("top",a+o-r.height()/2),i=Math.max(0,i),i=Math.min(i,1),m(i)}var h=function(t){if(!o.is(":visible"))return o.show(),h(t),o.hide();var e=l.height(),n=l.position(),a=e-e*t;s.height(e-a),s.css("top",n.top+a),r.css("top",n.top+a-r.height()/2)},m=function(t){var e,n;u(t),v.volume=t,e=d=t,(n=new Date).setTime(n.getTime()+31536e6),document.cookie="volume="+e+";path=/;expires="+n.toGMTString()+";"};e.find(".button").on("click",function(){return c?(c=!1,void(0!==d&&(u(d),v.volume=d,h(d)))):(c=!0,void(0!==d&&(u(0),v.volume=0,h(0))))}),e.hover(function(){i=!0,o.show()},function(){i=!1,a||o.hide()}),o.on("mouseover",function(){i=!0}).on("mousedown",function(t){return p(t),!(a=!0)}),$(document).on("mouseup",function(){a=!1,i||o.hide()}).on("mousemove",function(t){a&&p(t)}),function(){if(/volume\s*=/.test(document.cookie)){var t=document.cookie.replace(/.*volume\s*=\s*([^;]*);?.*/,"$1"),t=parseFloat(t);return h(t),m(t)}h(1)}()}(),(f=new Primus({url:location.protocol+"//"+location.host+"?room="+q,strategy:!1})).on("updateoverview",function(t,e){t!==q&&B[t].text(e)}),f.on("alreadyinaroom",function(){var t=['<div class="modal-header">',"<h3>Already in a room</h3>","</div>",'<div class="modal-body">','<div class="alert alert-error alert-block">','<h4 class="alert-heading">Warning!</h4>',"You are already in a room.<br/>","Leave the other room and refresh this page or close this one.","</div>","</div>"].join("");$(t).appendTo(Y),Y.modal("show")}),f.on("nickname",at),f.on("overview",function(e){$(".users-counter").each(function(){var t=$(this).prevAll(".room-name").text();B[t]=$(this),$(this).text(e[t])})}),f.on("end",function(){clearInterval(y),v.pause(),s($('<span class="error">ERROR: You have disconnected.</span>')),i("Something wrong happened"),S.empty()}),f.on("ready",function(t){m=t.nickname,t.loggedin?L=!0:document.cookie="nickname="+m+";path=/;",Y.modal("hide").empty(),$("#total-tracks span").text(t.trackscount);var e=$('<span class="join">'+m+" joined the game</span>");s(e),ct(t.usersData),W.on("keydown",function(t){if(13===t.keyCode){var e=W.val().trim();if(W.val(""),e){if(/^\/[^ ]/.test(e))return lt(e);if(g)return f.send("chatmsg",e,g);f.send("chatmsg",e)}}}),A.on("keydown",function(t){switch(t.keyCode){case 13:var e=A.val().trim();if(A.val(""),e){if(z.push(e),20<z.length&&z.splice(0,1),U=z.length,h)return f.send("guess",e.toLowerCase());i("You have to wait the next song...")}break;case 38:return 0<U&&A.val(z[--U]),!1;case 40:if(U<z.length-1)return A.val(z[++U]);U=z.length,A.val("")}}).on("paste",function(t){t.preventDefault()}).focus(),f.on("artistmatched",d(J,"correct")),f.on("bothmatched",d(Q,"correct")),f.on("chatmsg",o),f.on("gameover",a),f.on("loadtrack",l),f.on("newuser",ut),f.on("nomatch",d(X,"wrong")),f.on("playtrack",c),f.on("stoptrying",function(){i("You guessed both artist and title. Please wait...")}),f.on("titlematched",d(et,"correct")),f.on("trackinfo",n),f.on("updateusers",ct),f.on("userleft",pt),st(t.state)})}();